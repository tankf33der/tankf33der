# pure lisp madness and fun
#
(de pump (N)
   (cache
      '(NIL)
      N
      (let N (* 2 N)
         (if (>= N `(hex "100"))
            (x| N `(hex "11D"))
            N ) ) ) )
(de anbs (A B)
   (cdr (lup (nth *ANBS-T (inc A) 1) B)) )
(setq
   *ANBS-SBOX
   (quote
      167 211 230 113 208 172 77 121 58 201 145 252 30 
      71 84 189 140 165 122 251 99 184 221 212 229 179 
      197 190 169 136 12 162 57 223 41 218 43 168 203 
      76 75 34 170 36 65 112 166 249 90 226 176 54 125 
      228 51 255 96 32 8 139 94 171 127 120 124 44 87 
      210 220 109 126 13 83 148 195 40 39 6 95 173 103 
      92 85 72 14 82 234 66 91 93 48 88 81 89 60 78 56 
      138 114 20 231 198 222 80 142 146 209 119 147 69 
      154 206 45 3 98 182 185 191 150 107 63 7 18 174 
      64 52 70 62 219 207 236 204 193 161 192 214 29 
      244 97 59 16 216 104 160 177 10 105 108 73 250 
      118 196 158 155 110 153 194 183 152 188 143 133 
      31 180 248 17 46 0 37 28 42 61 5 79 123 178 50 
      144 175 25 163 247 115 157 21 116 238 202 159 
      15 27 117 134 132 156 74 151 26 101 246 237 9 
      187 38 131 235 111 129 4 106 67 1 23 225 135 245 
      141 227 35 128 68 22 102 33 254 213 49 217 53 24 
      2 100 242 241 86 205 130 200 186 240 239 233 232 
      253 137 215 199 181 164 47 149 19 11 243 224 55 ) )
# 1-based list of 0-based balanced trees,
# because I can.
(setq 
   *ANBS-T
   (make
      (for V 
         (quote
            (S1 S2 S4 S6)
            (S2 S1 S6 S4)
            (S4 S6 S1 S2)
            (S6 S4 S2 S1)
            (S1 S1 S1 S1)
            (X X2 X6 X8) )
         (let 
            (Tree NIL
               Lst
               (make
                  (for (I . N) *ANBS-SBOX
                     (let 
                        (S1 N
                           S2 (pump S1)
                           S4 (pump S2)
                           S6 (x| S4 S2)
                           X (dec I)
                           X2 (pump X)
                           X4 (pump X2)
                           X6 (x| X4 X2)
                           X8 (pump X4) )
                        (link
                           (cons
                              X
                              (apply 
                                 |
                                 (mapcar
                                    '((S N) (>> S (val N)))
                                    (-24 -16 -8 0)
                                    V ) ) ) ) ) ) ) )
               (balance 'Tree Lst)
               (link Tree) ) ) ) )

