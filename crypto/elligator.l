# lets rewrite elligator.sage on PicoLisp
(setq
   *P (- (** 2 255) 19)
   *A 486662
   *SQRT1 NIL
)
(de %% (X Y)
   (% (+ Y (% X Y)) Y) )
(de exp (A, B)
   (let D 1
      (for I (chop (bin B))
         (setq D (%% (* D D) *P))
         (and
            (= "1" I)
            (setq D (%% (* D A) *P)) ) )
      D ) )
(de invert (N)
   (exp N (- *P 2)) )
(de m_abs (N)
   (let M (%% N *P)
      (if (>= (/ (dec *P) 2) M)
         M
         (%% (- M) *P) ) ) )
(de chi (N)
   (exp N (/ (dec *P) 2)) )
(de is_square (N)
   (or (=0 (%% N *P)) (=1 (chi N))) )
(setq *SQRT1
   (m_abs
      (*
         (exp 2 (/ (dec *P) 4))
         (exp -1 (/ (+ *P 3) 8)) ) ) )
(de sqrt+ (N)
   (unless (is_square N)
      (quit "Not a square") )
   (let R (exp N (/ (+ *P 3) 8))
      (if (= (%% (* R R) *P) (%% N *P))
         (m_abs R)
         (m_abs (* R *SQRT1)) ) ) )
(de hash_to_curve (R)
   (let
      (W
         (%%
            (*
               (- *A)
               (invert (inc (* 2 (** R 2)))) )
            *P )
         E
         (%%
            (chi
               (+
                  (** W 3)
                  (* *A (** W 2))
                  W ) )
            *P )
         U
         (%%
            (-
               (* E W)
               (/ (* (- 1 E) *A) 2) )
            *P )
         V
         (%%
            (*
               (- E)
               (sqrt+
                  (+
                     (** U 3)
                     (* *A (** U 2))
                     U ) ) )
            *P ) )
      (cons U V) ) )
(test
   (12115847385937229292018649355599142032739908568210603284705358346106477529708 . 51373816238287372760555117023041920244688181187763450952574789490818585171223)
   (hash_to_curve 4578945789457894578456) )
(test
   23548909541754301439352610919600078944460680743004669453427379179075325930426
   (sqrt+ 4578945789457894578456) )
(test
   19681161376707505956807079304988542015446066515923890162744021073123829784752
   *SQRT1 )
(test 1 (is_square 457894578945454545))
(test NIL (is_square 457894578945454544))
(test 0 (chi *P))
(test 1 (chi 457894578945454545))
(test 1234567 (m_abs 1234567))
(test 0 (m_abs *P))
(test
   123456774577567895678956568989457894574578945789457894545789
   (m_abs -123456774577567895678956568989457894574578945789457894545789) )
(test 0 (invert *P))
(test
   40903448833803765304030505711834176292329494422674962581796698797273844702493
   (invert 45454545768457684576845765) )
(test
   926549609804623448265268294182900512918058893428212027689876489708283
   (exp 123 33) )
(test
   43579178365488290487999733433133644729453586639746054162384555965744964322950
   (exp 3244545454537834663434343434 10000000000000000000) )


(msg 'ok)
(bye)
